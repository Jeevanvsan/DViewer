<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unicons.iconscout.com/release/v4.0.0/css/thinline.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/eclipse.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/sql-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/comment/comment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/comment/continuecomment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/keymap/sublime.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/hint/show-hint.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/hint/show-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/sql/sql.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/hint/sql-hint.min.js"></script>

    <!-- <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"> -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>






    <title>DViewer</title>
    <style>
        body{
            margin: 0px;
            padding: 0px;
            font-family: 'Arimo', sans-serif;

        }
        .main_cont{
            width: 100%;
            height: 100vh;
        }
        header{
            background-color: rgb(16, 16, 16);
            height: 5vh;
            width: 100%;
            display: flex;
            justify-content: space-between;
        }
        .head_name h1{
            margin: 0;
            padding: 10px 0 0 40px;
            color: aliceblue;
        }
        
        .head_menu ul {
            padding: 0 40px 0 0 ;
            display: flex;
            list-style-type: none;
        }

        .head_menu a {
            padding: 0 10px 0 10px;
            text-decoration: none;
            color :aliceblue;
        }

        #addcon_btn{
            margin: 10px;
            background-color: #282626;
            color: #fff;
            padding: 5px 15px;
            font-size: 15px;
            border-radius: 3px;
            cursor: pointer;
            box-shadow: #000 0px 0px 4px 0px;

        }

        #addcon_btn:hover{
            box-shadow: #000 0px 0px 0px 0px;
        }

        .body_cont{
            height: 95vh;
            background-color: aqua;
            display: flex;
        }
        .left_cont{
            height: 95vh;
            width: 15%;
            background-color: #fff;
        }
        .middle_cont{
            height: 94.8vh;
            width: 65%;
            background-color: whitesmoke;
            border: solid 1px #dadada;
        }
        .right_cont{
            height: 95vh;
            width: 20%;
            background-color: #fff;
        }

        @import url('https://fonts.googleapis.com/css?family=Arimo:400,700&display=swap');
 

        .warpper{
        display:flex;
        flex-direction: column;
        align-items: center;
        margin-top: 5px;
        height: 94vh;
        }
        .tab{
        cursor: pointer;
        padding:10px 20px;
        margin:0px 2px;
        background:#000;
        display:inline-block;
        color:#fff;
        border-radius:3px 3px 0px 0px;
        box-shadow: 0 0.5rem 0.8rem #00000080;
        }
        .panels{
        background:#fffffff6;
        box-shadow: 0 2px 10px #00000080;
        height:60vh;
        min-height: 20vh;
        width:95%;
        border-radius:3px;
        overflow:hidden;
        padding:20px;  

        }
        .panel{
        display:none;
        animation: fadein .8s;
        }
      

        .radio{
            display:none;
            }
            #one:checked ~ .panels #one-panel,
            #two:checked ~ .panels #two-panel,
            #three:checked ~ .panels #three-panel,
            #four:checked ~ .panels #four-panel{
            display:block
            }
            #one:checked ~ .tabs #one-tab,
            #two:checked ~ .tabs #two-tab,
            #three:checked ~ .tabs #three-tab,
            #four:checked ~ .tabs #four-tab{
            background:#fffffff6;
            color:#000;
            border-top: 3px solid #000;
        }

        /* right panel */
        .warpper_1{
        display:flex;
        flex-direction: column;
        align-items: center;
        margin-top: 5px;
        }
        .tab_1{
        cursor: pointer;
        padding:10px 20px;
        margin:0px 2px;
        background:#000;
        display:inline-block;
        color:#fff;
        border-radius:3px 3px 0px 0px;
        box-shadow: 0 0.5rem 0.8rem #00000080;
        }

        .qry_tab_1{
        cursor: pointer;
        padding:10px 20px;
        margin:0px 2px;
        background:#000;
        display:inline-block;
        color:#fff;
        border-radius:3px 3px 0px 0px;
        box-shadow: 0 0.5rem 0.8rem #00000080;
        }
        .panels_1{
        background:#fffffff6;
        box-shadow: 0 2px 10px #00000080;
        height:85vh;
        width:88%;
        border-radius:3px;
        overflow:hidden;
        padding:20px;  
        }

        .qry_panels_1{
        background:#fffffff6;
        box-shadow: 0 2px 10px #00000080;
        height:85vh;
        width:88%;
        border-radius:3px;
        overflow:hidden;
        padding:20px;  
        }
        .panel_1{
        display:none;
        animation: fadein .8s;
        }

        .qry_panel_1{
        display:none;
        animation: fadein .8s;
        }
      

        .radio_1{
            display:none;
            }
            #one_1:checked ~ .panels_1 #one-panel_1,
            #two_1:checked ~ .panels_1 #two-panel_1{
            display:block
            }
            #one_1:checked ~ .tabs_1 #one-tab_1,
            #two_1:checked ~ .tabs_1 #two-tab_1{
            background:#fffffff6;
            color:#000;
            border-top: 3px solid #000;
        }

        .qry_radio_1{
            display:none;
            }
            #qry_one_1:checked ~ .qry_panels_1 #qry_one-panel_1{
            display:block
            }
            #qry_one_1:checked ~ .qry_tabs_1 #qry_one-tab_1{
            background:#fffffff6;
            color:#000;
            border-top: 3px solid #000;
        }

        #searchInput {
            height:1vh;
            background-position: 10px 12px; /* Position the search icon */
            background-repeat: no-repeat; /* Do not repeat the icon image */
            width: 30%; 
            font-size: 16px; /* Increase font-size */
            padding: 12px 20px 12px 40px; /* Add some padding */
            border: 2px solid #D3D3D3; 
            margin-bottom: 12px; /* Add some space below the input */
            border-radius:10px;
            box-shadow: 0 0 8px 3px #D3D3D3;
          }

          #struct_searchInput {
            height:1vh;
            background-position: 10px 12px; /* Position the search icon */
            background-repeat: no-repeat; /* Do not repeat the icon image */
            width: 30%; 
            font-size: 16px; /* Increase font-size */
            padding: 12px 20px 12px 40px; /* Add some padding */
            border: 2px solid #D3D3D3; 
            margin-bottom: 12px; /* Add some space below the input */
            border-radius:10px;
            box-shadow: 0 0 8px 3px #D3D3D3;
          }

          #source_name a{
            cursor: pointer;
          }
          #source_name{
            overflow: auto;
            height: 93vh;
          }
          #source_name h2{
            font-size: 15px;
            }
          #data_tbl{
            font-size: 12px;
            width: 100%;
            user-select: none;
            background: white;
            border-radius:3px;
            border-collapse: collapse;
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
            animation: float 5s infinite
          }
          #data_tbl td:hover{
            border: solid 2px rgba(0, 183, 255, 0.83);
          }
          #data_tbl th{
            position: sticky;
            top: 0;
            background-color: #000;
            color: #fff;
            padding: 10px;

          }
          #data_tbl td{
            padding: 10px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
          }

          #data_tbl td:hover{
            border: solid 2px rgba(0, 183, 255, 0.83);
          }
          #data_tbl th{
            position: sticky;
            top: 0;
            background-color: #000;
            color: #fff;
            padding: 10px;

          }
          #data_tbl td{
            padding: 10px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
          }
          #table_cont{
            height: 55vh;
            width: 100%;
            margin: 0;
            overflow: auto;
          }

          #struct_table_cont{
            height: 55vh;
            width: 100%;
            margin: 0;
            overflow: auto;
          }

          #struct_data_tbl{
            font-size: 12px;
            width: 100%;
            user-select: none;
            background: white;
            border-radius:3px;
            border-collapse: collapse;
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
            animation: float 5s infinite
          }
          #struct_data_tbl td:hover{
            border: solid 2px rgba(0, 183, 255, 0.83);
          }
          #struct_data_tbl th{
            position: sticky;
            top: 0;
            background-color: #000;
            color: #fff;
            padding: 10px;

          }
          #struct_data_tbl td{
            padding: 10px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
          }

          #struct_data_tbl td:hover{
            border: solid 2px rgba(0, 183, 255, 0.83);
          }
          #struct_data_tbl th{
            position: sticky;
            top: 0;
            background-color: #000;
            color: #fff;
            padding: 10px;

          }
          #struct_data_tbl td{
            padding: 10px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
          }
         
          .highlight {
            border: solid 2px rgba(104, 204, 243, 0.83);
            background-color: rgba(30, 143, 255, 0.268);
          }

          .search_cont{
            display: flex;
            justify-content: space-between;

          }
          #value_cont{
            margin: 5px;
            height: 24vh;
            min-height: 24vh;
            width: 99%;
            background-color: rgb(255, 255, 255);
            border-radius: 10px;
            box-shadow: 1px 2px 10px #000;
            overflow: hidden;
          }
          #value_cont_cont{
            padding: 10px;
            height: 21vh;
            min-height: 21vh;
            overflow: auto;

            /* background-color: rgb(231, 59, 59); */

          }

          #value_cont_cont h4{
            padding: 10px 10px 0 10px;
          }

          #value_cont_cont pre{
            font-size: 18px;
            padding: 0 30px 30px 30px;
          }

          /* filter */

        .div-container {
            border: 1px solid #ccc;
            padding: 0px;
            margin-bottom: 10px;
            transition: height 0.3s;
            overflow: hidden;
            border-radius: 4px;
            box-shadow:  0px 1px 3px #797979;
        }

        .div-container_join {
            border: 1px solid #ccc;
            padding: 0px;
            margin-bottom: 10px;
            transition: height 0.3s;
            overflow: hidden;
            border-radius: 4px;
            box-shadow:  0px 1px 3px #797979;
        }

        .div-header {
            display: flex;
            justify-content: space-between;
            cursor: pointer;
            background-color: #e3e3e3;
            padding: 5px;
        }

        .div-header_join {
            display: flex;
            justify-content: space-between;
            cursor: pointer;
            background-color: #e3e3e3;
            padding: 5px;
        }

        .close-btn{
            font-size: 25px;
            color: #797979;
            padding: 0 10px 0 0;
        }

        .div-content{
            padding: 10px;
        }

        .minimized .div-content {
            display: none;
        }

        .minimized .div-content_join {
            display: none;
        }

        .minimized .cols_div {
            display: none;
        }

        .div-content_join{
            padding: 10px;
        }

        #filter_cont #join_cont{
            height: 84vh;
            overflow-y: auto;
        }

        #addDivButton {
            margin: 10px;
            background-color: #000;
            color: #fff;
            padding: 5px 15px;
            font-size: 15px;
            border-radius: 3px;
            cursor: pointer;
            box-shadow: #000 0px 0px 3px 0px;

        }

        #addDivButton:hover{
            box-shadow: #000 0px 0px 0px 0px;
        }

        #addJoin{
            margin: 10px;
            background-color: #000;
            color: #fff;
            padding: 5px 15px;
            font-size: 15px;
            border-radius: 3px;
            cursor: pointer;
            box-shadow: #000 0px 0px 3px 0px;

        }

        #addJoin:hover{
            box-shadow: #000 0px 0px 0px 0px;
        }

        

        #filter_columns p{
        font-size: 15px;
        }
        #filter_columns ul{
        display: flex;
        flex-wrap: wrap;
        padding: 7px;
        margin: 12px 0;
        border-radius: 5px;
        border: 1px solid #a6a6a6;
        }
        #filter_columns ul  li{
        color: #333;
        margin: 4px 3px;
        list-style: none;
        border-radius: 5px;
        background: #F2F2F2;
        padding: 5px 8px 5px 10px;
        border: 1px solid #e3e1e1;
        }
        #filter_columns ul li i{
        height: 20px;
        width: 20px;
        color: #808080;
        margin-left: 8px;
        font-size: 12px;
        cursor: pointer;
        border-radius: 50%;
        background: #dfdfdf;
        justify-content: center;
        }
        #filter_columns ul input{
        flex: 1;
        padding: 5px;
        border: none;
        outline: none;
        font-size: 16px;
        }
        .suggestion {
        cursor: pointer;
        background-color: #f0f0f0;
        padding: 5px;
        margin-top: 2px;
        }
        .suggestion:hover {
            background-color: #e0e0e0;
        }

        #filter_option{
            padding: 5px;
            font-size: 16px;
            width: 100%;
            border-radius: 3px;
        }

        .logic1_opt{
            margin: 10px;
            margin-top: 0;
            padding: 5px;
            font-size: 16px;
            width: 90%;
            border-radius: 3px;
        }

        .logic1_value{
            margin: 10px;
            margin-top: 0;
            padding: 5px;
            font-size: 16px;
            width: 90%;
            border-radius: 3px;
        }
        .apply_btn{
            font-size: 14px;
            background: transparent;
            border: none;
            padding: 10px;
            cursor: pointer;
        }
        .join_apply_btn{
            font-size: 14px;
            background: transparent;
            border: none;
            padding: 10px;
            cursor: pointer;
        }
        .hidden_p{
            display:none;
        }
        .resizer {
            width: 64%;
            cursor: row-resize;
            height: 3px;
            position: absolute;
            background-color: #000000;
            display: none;
        }
        .resizer:hover{
            background-color: #1f9cf6;
        }
        
        #query_main{
            margin: 0;
            display: flex;
            flex-direction: column;
        }

        #query_top{
            border-bottom: 1px solid #b4b1b1;
            height: 4vh;
            padding-bottom: 10px;
        }

        #query_sheet{
            overflow: hidden;
            height:57vh;
            display: flex;
            flex-direction: row;
        }

        #sheet_middle{
            height:56vh;
            width: 100%;
        }
        .CodeMirror {
            margin-top: 10px;
            height: 56vh;
            font-size: 17px;
            }

        
        

        #data_tbl_query{
            font-size: 12px;            
            user-select: none;
            background: white;
            border-radius:3px;
            border-collapse: collapse;
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
            animation: float 5s infinite
        }
        #data_tbl_query td:hover{
            border: solid 2px rgba(0, 183, 255, 0.83);
        }

        #data_tbl_query th{
            position: sticky;
            top: 0;
            background-color: #000;
            color: #fff;
            padding: 10px;

        }
        #data_tbl_query td{
            padding: 10px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .CodeMirror-hints {
            background-color: #f5f5f5; 
            color: #333; 
            border: 1px solid #ccc; 
            border-radius: 4px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
            font-family: Arial, sans-serif; 
            font-size: 14px; 
        }
        .CodeMirror-hint {
            padding: 4px 8px; 
        }
        .CodeMirror-hint-active {
            background-color: #ccc; 
        }
        #query_run_btn{
            background-color: #000;
            color: #fff;
            padding: 5px 15px;
            font-size: 15px;
            border-radius: 3px;
            cursor: pointer;
        }

        #connections_select{
            background-color: #000;
            color: #fff;
            padding: 5px 15px;
            font-size: 15px;
            border-radius: 3px;
        }
        #table_select{
            background-color: #000;
            color: #fff;
            padding: 5px 15px;
            font-size: 15px;
            border-radius: 3px;
        }

        #addDivButton{
            background-color: #000;
            color: #fff;
            padding: 5px 15px;
            font-size: 15px;
            border-radius: 3px;
            cursor: pointer;
        }

        #loader {
            position: fixed;
            width: 100%;
            height: 100vh;
            background-color: #000000ca;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 25px;
            color: white;
        }

        
        #data_right{
            display: none;
        }

        .join_opt{
            margin: 10px;
            margin-top: 0;
            padding: 5px;
            font-size: 16px;
            width: 90%;
            border-radius: 3px;
        }
        #tbl_ul p{
            font-size: 18px;
            background-color: #c2c2c2;
            padding: 4px 10px;
        }

        .main-heading, .element-heading {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }


        .column-name {
            list-style: none;
            font-size: 14px;
            display: none; 
            margin-left: 20px;
            padding-left: 10px; 
            border-bottom-left-radius: 5px;
            background-color: #8080803a;
            border-bottom: #333 1px solid;
            border-left: #333 1px solid;border-top: #333 1px solid;
            border-top: #3333333f 1px solid;
            margin-bottom: 10px;
            color: #4f4d4d;
            font-weight: bold;
            width: 100%;

        }

        .icon {
            cursor: pointer;
            color: #797979;
            margin-right: 10px;
        }

        .main-heading {
            font-weight: bold;
            line-height: 30px;
        }

        .element-heading {
            font-weight: normal;
            font-size: 16px;
            margin-left: 20px; 
            background-color: #7979792c;
            padding: 5px 25px 5px 10px;
            border-top-left-radius: 5px;
            border-top: #333 1px solid;
            border-left: #333 1px solid;
            border-bottom: #3333333f 1px solid;
            width: 100%;

        }

        .element-heading :hover{
            opacity: 70%;
        }

        #column_name_li{
            border-bottom: #00000044 solid 1px; 
            padding: 4px;
        }

        #settings_div{
            height: 59vh;
            overflow: auto;
        }

        #settings_table{
            border: 3px solid #6565656c;
            border-radius: 5px;
            width: 80%;
        }

        #settings_table td {
            padding: 10px;
            border-bottom: 2px solid #65656537;

        }

        #settings_table th {
            padding: 10px;
            border-bottom: 2px solid #65656537;
            text-align: left;

        }

        #addCon_div {
            position: fixed;
            width: 100%;
            height: 100vh;
            background-color: #000000ca;
            display: none;
            justify-content: center;
            align-items: center;
            font-size: 25px;
            color: white;
        }
        #con_inputs_div {
            background-color: #c6c6c6;
            width: 50%;
            height: 70vh;
            position: absolute;
            border-radius: 10px;
        }

        #con_input_close_btn{
            position: absolute;
            top: -40px;
            right: -40px;
            background: transparent;
            border: 1px solid #fff;
            color: white;
            border-radius: 49%;
            font-size: 1.3em;
            padding: 10px 15px;
            cursor: pointer;
        }
        #addcon_head{
            color: #4f4c4c;
            font-size: 1.2em;
            text-align: center;
        }

        #con_inputs_table th{
            color: #4f4c4c;
            font-size: 0.8em;
            padding: 20px;
        }

        #con_inputs_table td{
            color: #4f4c4c;
        }
        #con_inputs_table{
            width: 80%;
            text-align: left;
        }

        #con_inputs_table tr {
            padding: 10px;
        }

        /*----------------------------------------------------------------*/

        #con_inputs_table_2 th{
            color: #4f4c4c;
            font-size: 0.8em;
            padding: 20px;
        }

        #con_inputs_table_2 td{
            color: #4f4c4c;
        }
        #con_inputs_table_2{
            width: 80%;
            text-align: left;
        }

        #con_inputs_table_2 tr {
            padding: 10px;
        }

        #form_table{
            width: 90%;
            margin-left: 30px;
            height: 50vh;
            overflow-x: auto ;
            background-color: #fff;
            border-radius: 10px;
            border: #4f4d4d4f 1px solid;
            box-shadow: 0px 0px 0px 1px #4f4d4d4f;
            padding: 10px 15px;
        }

        #conn_save_btn{
            background-color: #000000ca;
            justify-content: center;
            align-items: center;
            font-size: 17px;
            color: white;
            position: absolute;
            margin-top: 30px;
            padding: 10px 30px;
            border-radius: 5px;
            left: 45%;
            cursor: pointer;
        }

        .inp_text{
            font-size: 0.8em;
            background-color: transparent;
            border-radius: 3px;
            border: none;
            border-bottom: #4f4d4d 1px solid;
            width: 100%;

        }

        .inp_text:focus{
            border: none;
            border-bottom: #4f4d4d 1px solid;
            outline: none;

        }

        .con_select{
            font-size: 0.8em;
            border: none;
            border-bottom: #4f4d4d 1px solid;
            
            padding: 10px;
        }

        .con_select:focus{
            border: none;
            border-bottom: #4f4d4d 1px solid;
            outline: none;

        }

        
        #file {
            cursor: pointer; 
            padding: 20px;
            margin-top: 10px;
            font-size: 16px;
        } 

        #con_err_p{
            font-size: 0.6em;
            color: red;
            margin-left: 100px;
        }

        #con_ok_p{
            font-size: 0.6em;
            color: green;
            margin-left: 100px;
        }
        
        
    </style>
</head>
<body>
    <div id="loader">
        <p>Establishing connections with sources</p>
    </div>
    <div class="main_cont">
        <header>
            <div class="head_name">
                <h1>
                    DViewer
                </h1>
            </div>
            <div class="head_menu">
                <ul>
                    <li></li>
                    <li><a href="">FAQ</a></li>
                    <li><a href="">About</a></li>
                </ul>
            </div>
        </header>
        <div id="addCon_div">
            <div id="con_inputs_div">
                <button id="con_input_close_btn" onclick="close_addCon_div()"><i class="fa fa-close" aria-hidden="true"></i></button>
                <h1 id="addcon_head">New connection</h1>
                <!-- <form enctype="multipart/form-data"> -->
                    <div id="form_table">
                        <table id="con_inputs_table">
                            <tr>
                                <th>connection name</th>
                                <td><input type="text" class="inp_text" id="con_name_input" required></td>
                            </tr>
                            <tr>
                                <th>source</th>
                                <td><select id="con_source_select" class="con_select"></select></td>
                            </tr>
                        </table>
                        <table id="con_inputs_table_2">
                        </table>
                    </div>
                    <button id="conn_save_btn" onclick="save_con()" >save</button><p id="con_err_p"></p><p id="con_ok_p"></p>
                <!-- </form> -->
            </div>
        </div>
        <div class="body_cont" id="body_cont"  >
            <div class="left_cont">
                <button onclick="addConnection()" id="addcon_btn">Add connection</button>
                <ul id="source_name">

                </ul>
            </div>
            <div class="middle_cont" >
                <div class="warpper" >
                    <input class="radio" id="one" name="group" type="radio" checked>
                    <input class="radio" id="two" name="group" type="radio">
                    <input class="radio" id="three" name="group" type="radio"  >
                    <input class="radio" id="four" name="group" type="radio" >
                    <div class="tabs">
                    <label class="tab" id="one-tab" for="one">Worksheet</label>
                    <label class="tab" id="two-tab" for="two">Data</label>
                    <label class="tab" id="three-tab" for="three">Structure</label>
                    <label class="tab" id="four-tab" for="four">Settings</label>
                    </div>
                    <div class="panels" id="panels" >
                        <div class="panel" id="one-panel">
                            <div id="query_main">
                                <div id="query_top">
                                    <button id="query_run_btn" onclick="run_query()">run</button>
                                    <select id="connections_select"></select>
                                    <select id="table_select"></select>
                                </div>
                                <div id="query_sheet" >
                                    <div id="sheet_middle" >
                                        <textarea id="query_inp"></textarea>
                                    </div>
                                </div>
                            </div>
                            
                            

                        </div>

                        <div class="panel" id="two-panel">
                            <div class="search_cont">
                                <input type="text" id="searchInput" placeholder="Search ...">
                                <p id="tbl_name">No source selected</p>
                                <p id="loading_p"></p>
                                <p id="hidden_con" class="hidden_p"></p>
                                <p id="hidden_source" class="hidden_p"></p>
                                <p id="hidden_name" class="hidden_p"></p>
                            </div>
                            <div id="table_cont">
                                <table>

                                </table>
                            </div>
                                                    
                        </div>
                        <div class="panel" id="three-panel">
                            <input type="text" id="struct_searchInput"  placeholder="Search ...">
                            <div id="struct_table_cont">
                                <table>

                                </table>
                            </div>
                        </div>
                        <div class="panel" id="four-panel">
                            <div id="settings_div">
                                <h3 id="settings_heading"></h3>
                                <table id="settings_table">
                                    
                                </table>
                            </div>
                        </div>
                    </div>
                    <div id="value_cont" class="value_cont">
                        <div class="resizer" id="resizer"></div>
                        <div id="value_cont_cont" >
                            <p id="rs_p">Result</p>
                        </div>
                    </div>
                </div>
                
            </div>
            <div class="right_cont">
                <div class="warpper_1" id="data_right" >
                    <input class="radio_1" id="one_1" name="group_1" type="radio" checked>
                    <input class="radio_1" id="two_1" name="group_1" type="radio">
                    <div class="tabs_1">
                    <label class="tab_1" id="one-tab_1" for="one_1">filter</label>
                    <label class="tab_1" id="two-tab_1" for="two_1">calculation</label>
                    </div>
                    <div class="panels_1">
                        <div class="panel_1" id="one-panel_1">
                            <button id="addDivButton">Add filter</button>

                            <div id="filter_cont">
                                <div id="columnSelector" class="div-container ">
                                    <div class="div-header" onclick="toggleColumnSelector()">Column Selector</div>
                                    <div class="div-content">
                                        <label><input type="checkbox"  id="selectAll"> Select All</label>
                                        <div id="columnCheckboxes"></div>
                                    </div>
                                </div>
                                <div id="container">

                                </div>
                            </div>
                        </div>

                        <div class="panel_1" id="two-panel_1">
                            calculation                           
                        </div>
                    </div>
                </div>

                <!-- ------------------------------------------------- -->

                <div class="warpper_1" id="query_right">
                    <input class="qry_radio_1" id="qry_one_1" name="qry_group_1" type="radio" checked>
                    <div class="qry_tabs_1">
                    <label class="qry_tab_1" id="qry_one-tab_1" for="qry_one_1">Joins</label>
                    </div>
                    <div class="qry_panels_1">
                        <div class="qry_panel_1" id="qry_one-panel_1">
                            <button id="addJoin">Add join</button>

                            <div id="join_cont">
                                <div id="container_join">

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
<script>
    tags = {};
    selected_cols = {};
    qry_tbls = [];
    settings = {};
    int_conf = {};
    joins = {};
    cur_conn = '';
    cur_tbl = '';
    conn_add_err = [];

    

    

    // // console.log(socket)


    // let editor

    document.getElementById("two").addEventListener("click",()=>{
        document.getElementById("data_right").style.display="flex";
        document.getElementById("query_right").style.display="none";
    });

    document.getElementById("one").addEventListener("click",()=>{
        document.getElementById("data_right").style.display="none";
        document.getElementById("query_right").style.display="flex";
    });

 
    

    

    document.addEventListener("DOMContentLoaded", function() {


        fetch('/main')
            .then(response => response.json())
            .then(data => {

                settings = data["settings"]
                int_conf = data["int_conf"]
                // console.log(int_conf)
                // // console.log("data loaded");
                on_settings_got(data["settings"])
                

                document.getElementById('resizer').style.display = 'block';


                // query text editor

                editor = CodeMirror.fromTextArea(document.getElementById('query_inp'), {
                    mode: 'text/x-sql',
                    theme: 'eclipse',
                    lineNumbers: true,
                    keyMap: 'sublime', 
                    extraKeys: {
                        'Ctrl-/': 'toggleComment' ,
                        'Tab': 'autocomplete' 
                    }
                    });

                

                    function customHint(editor, options) {
                        var cur = editor.getCursor();
                        var token = editor.getTokenAt(cur);
                        var start = token.start;
                        var end = cur.ch;
                        var word = token.string.slice(0, end - start); // Remove conversion to lowercase for case-sensitive matching
                        var list = qry_tbls;

                        // Filter list based on current word
                        var customList = list.filter(function(item) {
                            return item.indexOf(word) > -1; // Check if the typed text exists in the suggestion (case-sensitive)
                        });

                        // Use CodeMirror's SQL hinting to get SQL suggestions
                        var sqlHint = CodeMirror.hint.sql(editor, options);
                        var sqlList = sqlHint.list;

                        // Filter SQL suggestions based on current word
                        var filteredSqlList = sqlList.filter(function(item) {
                            return item.text.toLowerCase().indexOf(word.toLowerCase()) > -1;
                        });

                        // Combine custom and SQL suggestions
                        var combinedList = customList.concat(filteredSqlList.map(function(item) {
                            return item.text;
                        }));

                        // Show suggestions only if there's a match
                        if (combinedList.length > 0) {
                            return {
                            list: combinedList,
                            from: CodeMirror.Pos(cur.line, start),
                            to: CodeMirror.Pos(cur.line, end)
                            };
                        } else {
                            return null; // Return null to hide suggestions
                        }
                    }


                    // Step 4: Configure CodeMirror to use custom suggestions
                    editor.on('inputRead', function onChange(editor, input) {
                    CodeMirror.showHint(editor, customHint, {completeSingle: false});
                    });

                    // console.log(qry_tbls)
                    function checkWord(word) {
                        if (qry_tbls.includes(word)) {
                            // console.log(word);

                            document.getElementById('table_select').value = word;
                            // console.log(word + " found in the list!");
                        }
                    }

                    editor.on("keydown", function(cm, event) {
                        if (event.keyCode === 32) { // 32 is the keycode for space
                            var cursor = cm.getCursor();
                            var line = cm.getLine(cursor.line);
                            var word = line.slice(0, cursor.ch).split(" ").pop();
                            checkWord(word);
                        }
                    });

                    function checkWords() {
                        // console.log(qry_tbls);
                        var text = editor.getValue();
                        var words = text.split(/\s+|[,.;]+/);                        
                        words.forEach(function(word) {
                        if (qry_tbls.includes(word)) {
                            document.getElementById('table_select').value = word;

                            // console.log(word + " found in the list!");
                            // Call your function here if a word matches
                        }
                        });
                    }

                    editor.on("change", function(cm, changeObj) {
                        checkWords();
                    });

                // document.getElementById('content').style.display = 'block';
                // You can further populate the content div with data.settings here
                // document.getElementById('content').innerHTML = JSON.stringify(data.settings);
            })
            .catch(error => {
                // console.error('Error fetching data:', error);
            });
    });
    
    
    // // console.log('loaded');
    
    function on_settings_got(settings){
        console.log("nil")
        if (Object.keys(settings).length > 0) 
        {
            get_settings(settings);

            console.log(settings)

            
                
            wrksheet_con_select = document.getElementById('connections_select');
            wrksheet_tbl_select = document.getElementById('table_select');

            // // console.log(settings);
            for (key in settings['sources_list']) {
                option = document.createElement("option");
                option.text = key;
                option.value = key;
                wrksheet_con_select.appendChild(option)
            }
            source = settings['settings'][wrksheet_con_select.value]['source'];


            qry_tbls = settings['sources_list'][wrksheet_con_select.value];
            qry_tbls = qry_tbls.map(filename => filename.name.replace(`.${source}`, ""));
            // console.log(qry_tbls);



            settings['sources_list'][wrksheet_con_select.value].forEach((tbls)=>{
                tbls = tbls.name.replace(`.${source}`,'');
                option = document.createElement("option");
                option.text = tbls;
                option.value = tbls;
                wrksheet_tbl_select.appendChild(option)
            });
            

            // // console.log(wrksheet_con_select.value);
        }else{
            console.log("no setings")
            document.getElementById('loader').style.display = 'none';
        }
    }
    
   
    function toggleList(icon, element) {
    if (element.style.display === 'none') {
      element.style.display = 'block';
      icon.innerHTML = '<i class="fa fa-minus" aria-hidden="true"></i>'

    //   icon.textContent = '-';
    } else {
      element.style.display = 'none';
    //   icon.textContent = '+';
    icon.innerHTML = '<i class="fa fa-plus" aria-hidden="true"></i>'

    }
  }

    function get_settings(settings){
        var container = document.getElementById('source_name');
        // console.log(settings)

        data = settings['sources_list']

        // left side bar

        Object.keys(data).forEach(key => {
            const mainHeading = document.createElement('div');
            mainHeading.classList.add('main-heading');
            connection_name = key
            mainHeading.textContent = key;
            source = settings['settings'][connection_name]['source'];


            const mainIcon = document.createElement('span');
            mainIcon.classList.add('icon', 'icon-plus');
            // mainIcon.textContent = '+';

            // const iconElement = document.createElement('i');
            // iconElement.classList.add("fa-regular" ,"fa-plus");
            // iconElement.setAttribute('aria-hidden', 'true');

            // mainIcon.appendChild(iconElement);

            mainIcon.innerHTML = '<i class="fa fa-plus" aria-hidden="true"></i>'

            mainIcon.addEventListener('click', () => {
                toggleList(mainIcon, mainHeading.nextElementSibling);
            });

            mainHeading.prepend(mainIcon);
            
            const elementsContainer = document.createElement('div');
            elementsContainer.style.display = 'none';

            data[key].forEach(element => {
                name = element.name
                const elementHeading = document.createElement('div');
                elementHeading.classList.add('element-heading');
                elementHeading.innerHTML = `<a onclick="get_data('${connection_name}','${name}','${source}')">${name.replace(`.${source}`, '')}</a>`;
                // console.log(element.name)



                const elementIcon = document.createElement('span');
                elementIcon.classList.add('icon', 'icon-plus');
                // elementIcon.textContent = '+';
                elementIcon.innerHTML = '<i class="fa fa-plus" aria-hidden="true"></i>'

                elementIcon.addEventListener('click', () => {
                    toggleList(elementIcon, elementHeading.nextElementSibling);
                });

                elementHeading.prepend(elementIcon);

                const columnsList = document.createElement('ul');
                columnsList.classList.add('column-name');
                element.columns.forEach(column => {
                    // console.log(column)
                    const columnItem = document.createElement('li');
                    columnItem.id = "column_name_li";
                    columnItem.textContent = `${column.name} (${column.dataType})`;
                    columnsList.appendChild(columnItem);
                });

                elementsContainer.appendChild(elementHeading);
                elementsContainer.appendChild(columnsList);
            });

            container.appendChild(mainHeading);
            container.appendChild(elementsContainer);
            });

        document.getElementById('loader').style.display = 'none';
        

    }

    function toggle_fn(e){
        // console.log(e.target);
    // e.target.querySelector('div').classList.toggle('minimized');
  
    }

    function get_data(connection_name,name,source) {

        document.getElementById('two').checked = true;
        document.getElementById("data_right").style.display="flex";
        document.getElementById("query_right").style.display="none";


        document.getElementById('tbl_name').innerHTML = 'Loading...';
        document.getElementById('loading_p').innerHTML = 'Loading...';
        document.getElementById('table_cont').innerHTML = '';
        document.getElementById('struct_table_cont').innerHTML = '';
        document.getElementById('settings_table').innerHTML = '';
        document.getElementById('settings_heading').innerHTML = '';
        
        document.getElementById('container').innerHTML = '';

        document.getElementById('hidden_con').innerHTML = '';
        document.getElementById('hidden_source').innerHTML = '';
        document.getElementById('hidden_name').innerHTML = '';

        fetch(`/get_data/${connection_name}/${name}/${source}`) 
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            document.getElementById('tbl_name').innerHTML = `${name}`;
            document.getElementById('loading_p').innerHTML = 'selected top 100';
            document.getElementById('table_cont').innerHTML = data['html']
            document.getElementById('struct_table_cont').innerHTML = data['struct']

            document.getElementById('settings_heading').innerHTML = connection_name
            
            set = settings['settings'][connection_name]
            for (key in set){
                console.log(key)
                tr = document.createElement('tr')
                th = document.createElement('th')
                th.innerHTML = key
                tr.appendChild(th)
                td = document.createElement('td')
                td.innerHTML = set[key]
                tr.appendChild(td)

                document.getElementById('settings_table').appendChild(tr)  
            }

            

            
            

            // // console.log(data['struct']);

            document.getElementById('hidden_con').innerHTML = connection_name
            document.getElementById('hidden_source').innerHTML = source
            document.getElementById('hidden_name').innerHTML = name

            if (data['filters']){
                for (id in data['filters']){
                    // console.log(id);
                    // console.log(data);

                    addDiv(id,true);
                    filterDiv(id,data['filters'][id],true);
                }
            }
            // // console.log(data);
            const table = document.getElementById('data_tbl');
            const rows = table.querySelectorAll('tr');

            if(Object.keys(data['selected_cols']).length != 0){
                indexes = data['selected_cols']
                

                connection_name = document.getElementById('hidden_con').innerHTML 
                source = document.getElementById('hidden_source').innerHTML 
                name = document.getElementById('hidden_name').innerHTML 

                fid = `${connection_name}_${source}_${name}`
                if (!selected_cols[fid]){
                    selected_cols[fid] = {}
                }

                generateColumnSelector(table, data['selected_cols'],ex_filter = true);


                for (key in indexes){
                    index = key;
                    value = indexes[key];
                    rows.forEach(row => {
                    const cells = row.querySelectorAll(`th, td`);
                    if (cells[index]) {
                        cells[index].style.display = value;
                        selected_cols[fid][index] = value;

                    }
                });
                }
            }else{
                // // console.log("11");
                generateColumnSelector(table);
            }

        })
        .catch(error => {
            // console.error('Error fetching data:', error);
            // Handle errors here
        });
    }
    
    // Row highlight

    function attachDoubleClickHandler(table) {
            table.addEventListener('dblclick', function(event) {
                const cell = event.target;
                const row = cell.closest('tr');
                
                if (row) {
                    // Toggle highlight for the clicked row
                    row.classList.toggle('highlight');
                }
            });
        }

    // Column highlight
    function attachClickHandlerToHeaders(table) {
        const headers = table.querySelectorAll('th');
        headers.forEach(function(header, index) {
            header.addEventListener('click', function() {
                const rows = table.querySelectorAll('tr');
                rows.forEach(function(row) {
                    const cells = row.querySelectorAll('td');
                    cells.forEach(function(cell, cellIndex) {
                        // Toggle highlight for the clicked column
                        if (cellIndex === index) {
                            cell.classList.toggle('highlight');

                        }
                    });
                });
            });
        });
    }

    // Value view
    function attachClickHandlerToCell(table) {
        table.addEventListener('click', function(event) {
            const cell = event.target;
            var val = cell.innerHTML;

            if (cell.tagName.toLowerCase() === 'td') {
                const cellIndex = cell.cellIndex;
                const headerRow = table.querySelector('thead tr');
                const headerCell = headerRow ? headerRow.cells[cellIndex] : null;

                if (headerCell) {
                    var column = headerCell.innerHTML.replace(/[▲▼]/g, '');
                    try {
                        const correctedJsonString = val.replace(/'/g, '"');
                        // console.log(correctedJsonString);
                        val = JSON.parse(correctedJsonString);
                        // console.log(val);
                        document.getElementById('value_cont_cont').innerHTML = `<h4>${column}</h4><pre>${JSON.stringify(val, undefined, 2)}</pre>`

                    } catch (e) {

                        // console.log(e);

                        document.getElementById('value_cont_cont').innerHTML = `<h4>${column}</h4><pre>${val}</pre>`
                        
                    }
                } else {
                    // console.log('No corresponding header cell found');
                }
            }
        });
    }

    // Sort

    function attachClickHandlerToSort(table){
    // var table = document.getElementById('data_tbl');
    var headers = table.querySelectorAll('th');
    var asc = true;

    headers.forEach(function(header, index) {{
        var sortIcon = document.createElement('span');
        sortIcon.innerHTML = '&#9650;'; // Ascending arrow
        sortIcon.classList.add('sort-icon');
        header.appendChild(sortIcon);

        header.addEventListener('click', function() {
            var rows = Array.prototype.slice.call(table.querySelectorAll('tbody tr'), 0);

            rows.sort(function (a, b) {{
                var cellA = a.querySelectorAll('td')[index].innerText;
                var cellB = b.querySelectorAll('td')[index].innerText;

                if (!isNaN(cellA) && !isNaN(cellB)) {{
                    return asc ? cellA - cellB : cellB - cellA;
                }}
                
                return asc ? cellA.localeCompare(cellB) : cellB.localeCompare(cellA);
            }});

            asc = !asc;
            sortIcon.innerHTML = asc ? '&#9650;' : '&#9660;'; // Toggle arrow

            rows.forEach(function(row) {{
                table.querySelector('tbody').appendChild(row);
            }});
        });
    }});
    }

    // filter

    document.getElementById('selectAll').addEventListener('change', (event) =>{
        connection_name = document.getElementById('hidden_con').innerHTML 
        source = document.getElementById('hidden_source').innerHTML 
        name = document.getElementById('hidden_name').innerHTML 

        fid = `${connection_name}_${source}_${name}`
        if (!selected_cols[fid]){
            selected_cols[fid] = {}
        }

        selected_cols[fid] = {"-1":event.currentTarget.checked};
        
        // // console.log(event.currentTarget.checked);
        const checkboxes = document.querySelectorAll('#columnCheckboxes input[type="checkbox"]');
        checkboxes.forEach(checkbox => {
                checkbox.checked = event.currentTarget.checked;
                const index = checkbox.dataset.column;

                const table = document.getElementById('data_tbl');
                const rows = table.querySelectorAll('tr');

                rows.forEach(row => {
                    const cells = row.querySelectorAll(`th, td`);
                    if (cells[index]) {
                        cells[index].style.display = checkbox.checked ? '' : 'none';

                    }
                });
            
            });

            fetch(`/column_filter/${selected_cols}`,{
            headers : {
            'Content-Type' : 'application/json'
            },
            method : 'POST',
            body : JSON.stringify(selected_cols)
            }) 
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                // document.getElementById('table_cont').innerHTML = data['html'] 
            })
            .catch(error => {
                // console.error('Error fetching data:', error);
                // Handle errors here
            });
    });


    function generateColumnSelector(table, columns,ex_filter = false) {
        // const table = document.getElementById('data_tbl');
        if(!ex_filter) {
            // // console.log('no ex_filter')
            const headers = table.querySelectorAll('th');
            const columnCheckboxes = document.getElementById('columnCheckboxes');

            document.getElementById('selectAll').checked = true;


            columnCheckboxes.innerHTML = ''

            headers.forEach((header, index) => {
                const label = document.createElement('label');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = true;
                checkbox.dataset.column = index;
                checkbox.onchange = toggleColumn;

                label.appendChild(checkbox);
                label.appendChild(document.createTextNode(header.textContent.replace(/[▲▼]/g, '')));
                columnCheckboxes.appendChild(label);
                columnCheckboxes.appendChild(document.createElement('br'));
        });
        }else{
            // console.log("columns")
            // for (key in columns){
                const headers = table.querySelectorAll('th');
                const columnCheckboxes = document.getElementById('columnCheckboxes');
    
                columnCheckboxes.innerHTML = ''
    
                headers.forEach((header, index) => {

                    const label = document.createElement('label');
                    checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.checked = true;

                    if (key == '-1' && columns[key] == true){
                        document.getElementById('selectAll').checked = true;
                    }

                    checkbox.dataset.column = index;
                    checkbox.onchange = toggleColumn;
    
                    label.appendChild(checkbox);
                    label.appendChild(document.createTextNode(header.textContent.replace(/[▲▼]/g, '')));
                    columnCheckboxes.appendChild(label);
                    columnCheckboxes.appendChild(document.createElement('br'));

                    const allCheckboxes = document.querySelectorAll('#columnCheckboxes input[type="checkbox"]');
                    for (let i = 0; i < allCheckboxes.length; i++){
                        if (columns[i] !='none'){
                            document.getElementById('selectAll').checked = false;
                            allCheckboxes[i].checked = true;
                            
                        
                        }else{
                            allCheckboxes[i].checked = false;

                        }

                    }
                    
                    
            });
        // }
        
    }
}

    function toggleColumn() {
        console.log("toggleColumn")
        const index = this.dataset.column;
        const table = document.getElementById('data_tbl');
        const rows = table.querySelectorAll('tr');

        connection_name = document.getElementById('hidden_con').innerHTML 
        source = document.getElementById('hidden_source').innerHTML 
        name = document.getElementById('hidden_name').innerHTML 

        fid = `${connection_name}_${source}_${name}`
        if (!selected_cols[fid]){
            selected_cols[fid] = {}
        }

        rows.forEach(row => {
            const cells = row.querySelectorAll(`th, td`);
            if (cells[index]) {
                cells[index].style.display = this.checked ? '' : 'none';
            }
        });


        // Check if all individual checkboxes are checked
        const allCheckboxes = document.querySelectorAll('#columnCheckboxes input[type="checkbox"]');
        for (let i = 0; i < allCheckboxes.length; i++){
            selected_cols[fid][i] = allCheckboxes[i].checked ? '' : 'none';

        }
        const allChecked = Array.from(allCheckboxes).every(checkbox => checkbox.checked);
        document.getElementById('selectAll').checked = allChecked;

        if (allChecked){
            selected_cols[fid] = {'-1':allChecked}
        }
        else if ('-1' in selected_cols[fid]){
            selected_cols[fid]['-1'] = allChecked

        }
        // console.log(selected_cols)


        fetch(`/column_filter/${selected_cols}`,{
            headers : {
            'Content-Type' : 'application/json'
        },
        method : 'POST',
        body : JSON.stringify(selected_cols)
        }) 
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            // document.getElementById('table_cont').innerHTML = data['html'] 
        })
        .catch(error => {
            // console.error('Error fetching data:', error);
            // Handle errors here
        });
    }

    function toggleColumnSelector() {
        const columnSelector = document.getElementById('columnSelector');
        columnSelector.classList.toggle('minimized');
    }

   


    document.addEventListener('DOMContentLoaded', function() {
        const tableContainer = document.getElementById('table_cont');
        const tableContainer2 = document.getElementById('struct_table_cont');
        const container = document.getElementById('container');
        const searchInput = document.getElementById('searchInput');
        const struct_searchInput = document.getElementById('struct_searchInput');

        let tableRows = [];
        let struct_tableRows = [];

        // Create an observer to watch for changes in the table container
        const observer1 = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.addedNodes.length > 0) {
                    mutation.addedNodes.forEach(function(node) {
                        if (node.nodeName === 'TABLE') {
                            attachDoubleClickHandler(node);
                            attachClickHandlerToHeaders(node);
                            attachClickHandlerToCell(node);
                            attachClickHandlerToSort(node);
                            // generateColumnSelector(node);
                            tableRows = Array.from(node.querySelectorAll('tbody tr')); // Store all table rows

                        }
                    });
                }
            });
        });

        const observer2 = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.addedNodes.length > 0) {
                    mutation.addedNodes.forEach(function(node) {
                        if (node.nodeName === 'TABLE') {
                            struct_tableRows = Array.from(node.querySelectorAll('tbody tr')); // Store all table rows

                        }
                    });
                }
            });
        });

        const observer3 = new MutationObserver(function(mutations) {
            // console.log(mutations);
            mutations.forEach(function(mutation) {
                if (mutation.addedNodes.length > 0) {
                    mutation.addedNodes.forEach(function(node) {
                        if (node.nodeName === 'DIV') {
                            // filterDiv(node);
                        }
                    });
                }
            });
        });

        // Configure the observer to watch for child nodes being added
        observer1.observe(tableContainer, { childList: true });

        observer2.observe(tableContainer2, { childList: true });

        observer3.observe(container, { childList: true });

        searchInput.addEventListener('input', function() {
            const filter = searchInput.value;
            tableRows.forEach(function(row) {
                const cells = row.querySelectorAll('td');
                let rowVisible = false;
                cells.forEach(function(cell) {
                    if (cell.textContent.indexOf(filter) > -1) {
                        rowVisible = true;
                    }
                });
                if (rowVisible) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });

        struct_searchInput.addEventListener('input', function() {
            const filter = struct_searchInput.value;
            struct_tableRows.forEach(function(row) {
                const cells = row.querySelectorAll('td');
                let rowVisible = false;
                cells.forEach(function(cell) {
                    if (cell.textContent.indexOf(filter) > -1) {
                        rowVisible = true;
                    }
                });
                if (rowVisible) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });
    });


    document.getElementById('addDivButton').addEventListener('click', addDiv);
    document.getElementById('addJoin').addEventListener('click', addJoin);

    function addJoin() {
            id = "id" + Math.random().toString(16).slice(2)
            // console.log(id)
            const container = document.getElementById('container_join');

            // Create div container
            const divContainer = document.createElement('div');
            divContainer.classList.add('div-container_join');
            // divContainer.className = "cls" + Math.random().toString(16).slice(2)
            divContainer.id = id

            // Create header
            const divHeader = document.createElement('div');
            divHeader.classList.add('div-header_join');
            divHeader.textContent = 'join';
            divHeader.addEventListener('click', function() {
                divContainer.classList.toggle('minimized');
            });

            // Create close button
            const closeButton = document.createElement('span');
            closeButton.classList.add('close-btn');
            closeButton.textContent = '×';
            closeButton.addEventListener('click', function(e) {
                // removeFilterFromTable(divContainer.id);
                container.removeChild(divContainer);
            });
            
            // Append close button to header
            divHeader.appendChild(closeButton);

            const divContent = document.createElement('div');
            divContent.classList.add('div-content_join');
            const join_source = document.createElement('select');
            join_source.className = 'join_opt';

            join_source.id = 'join_source'

            const join_table = document.createElement('select');
            join_table.className = 'join_opt';

            join_table.id = 'join_table'

            // // console.log(settings);
            for (key in settings['sources_list']) {
                option = document.createElement("option");
                option.text = key;
                option.value = key;
                join_source.appendChild(option)
            }
            source = settings['settings'][join_source.value]['source'];

            qry_tbls = settings['sources_list'][join_source.value]
            // // console.log(qry_tbls)    
            qry_tbls = qry_tbls.map(filename => filename.name.replace(`.${source}`, ""));

            settings['sources_list'][join_source.value].forEach((tbls)=>{
                tbls = tbls.name.replace(`.${source}`,'');
                option = document.createElement("option");
                option.text = tbls;
                option.value = tbls;
                join_table.appendChild(option)
            });

            divContent.appendChild(join_source);
            divContent.appendChild(join_table);

            var apply_btn = document.createElement('button');
            apply_btn.textContent = 'Apply';
            apply_btn.id = 'join_apply_btn'+id;
            apply_btn.className = 'join_apply_btn';
            divContent.appendChild(apply_btn);

            // Append header and content to container
            divContainer.appendChild(divHeader);
            divContainer.appendChild(divContent);

            // Append container to main container
            container.appendChild(divContainer);


            // Join options

            join_source.addEventListener('change', ()=>{
            
                document.getElementById('join_table').innerHTML = ''

                source = settings['settings'][join_source.value]['source'];

                qry_tbls = settings['sources_list'][join_source.value]
                qry_tbls = qry_tbls.map(filename => filename.name.replace(`.${source}`, ""));
                
                
                join_table.innerHTML = ''

                settings['sources_list'][join_source.value].forEach((tbls)=>{
                    
                    tbls["name"] = tbls.name.replace(`.${source}`,'');
                    option = document.createElement("option");

                    option.text = tbls["name"];
                    option.value = tbls["name"];
                    join_table.appendChild(option)
                });
                
            });

            apply_btn.addEventListener('click', () =>{
                cur_conn = document.getElementById('connections_select').value;
                cur_tbl = document.getElementById('table_select').value;

                join_con = join_source.value;
                join_tbl = join_table.value;
                
                id = apply_btn.id.replace("join_apply_btn","")

                comb = cur_conn + cur_tbl
                if (!(comb in joins)){
                    joins[comb] = {}
                }
                joins[comb][id] = {"connection" : join_con, "table" : join_tbl}
            });
    }

    function addDiv(id='fresh',ex_filter=false) {


        if(id != 'fresh' && ex_filter == true) {
            id_ = id
        }
        else{
            id_ = "id" + Math.random().toString(16).slice(2);

        }

        // console.log(id_);

        
        if(document.getElementById('data_tbl')){
        // if(1){

            
            const container = document.getElementById('container');

            // Create div container
            const divContainer = document.createElement('div');
            divContainer.classList.add('div-container');
            // divContainer.className = "cls" + Math.random().toString(16).slice(2)
            divContainer.id = id_

            // Create header
            const divHeader = document.createElement('div');
            divHeader.classList.add('div-header');
            divHeader.textContent = 'filter';
            divHeader.addEventListener('click', function() {
                divContainer.classList.toggle('minimized');
            });

            // Create close button
            const closeButton = document.createElement('span');
            closeButton.classList.add('close-btn');
            closeButton.textContent = '×';
            closeButton.addEventListener('click', function(e) {
                removeFilterFromTable(divContainer.id);
                container.removeChild(divContainer);
            });
            
            // Append close button to header
            divHeader.appendChild(closeButton);

            const divContent = document.createElement('div');
            divContent.classList.add('div-content');
            const select = document.createElement('select');
            select.id = 'filter_option'

            var option1 = document.createElement("option");
            option1.text = "None";
            option1.value = "None";
            // select.appendChild(option1);

            var option2 = document.createElement("option");
            option2.text = "condition";
            option2.value = "condition";
            select.appendChild(option2)

            divContent.appendChild(select);

            // Append header and content to container
            divContainer.appendChild(divHeader);
            divContainer.appendChild(divContent);

            // Append container to main container
            container.appendChild(divContainer);

            if (!ex_filter){
                filterDiv(divContainer);
            }


        }else{
            alert('choose any of the source')
        }
        
    }

    var appliedFilters = {}; // Object to store applied filters

    function column_selector_remain(){
        fid = `${connection_name}_${source}_${name}`

            const table = document.getElementById('data_tbl');
            const rows = table.querySelectorAll('tr');


            generateColumnSelector(table, selected_cols[fid],ex_filter = true);
            for (key in selected_cols[fid]){
                index = key;
                value = selected_cols[fid][key];
                rows.forEach(row => {
                const cells = row.querySelectorAll(`th, td`);
                    if (cells[index]) {
                        cells[index].style.display = value;
                        selected_cols[fid][index] = value;

                        }
                });
            }
    }

    function removeFilterFromTable(div_id,flag = true) {

        fetch(`/filter_remove/${div_id}`) 
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            document.getElementById('table_cont').innerHTML = data['html'] 
            column_selector_remain()
            
        })
        .catch(error => {
            // console.error('Error fetching data:', error);
            // Handle errors here
        });


    }

        
    function remove(element, div_id){
            // let index  = tags.indexOf(tag);
            // tags = [...tags.slice(0, index), ...tags.slice(index + 1)];
            // // console.log(tags);
            removeFilterFromTable(div_id, false);
            tags[div_id]["column_name"] = '';
            element.parentElement.remove();
        }

    function filtering(div,opt_val,ex_filter){
        var div_id = div.id



        if (ex_filter){
            div_id = div
            // console.log('heare=====')
            div_cont = document.getElementById(div_id)
            if (opt_val['condition'] =='condition'){

                tags[div_id] = opt_val
                var columns = document.createElement('div');
                columns.id = 'filter_columns';
                columns.innerHTML = `<ul id="tag_ul_${div_id}"><input id="col_${div_id}" type="text" spellcheck="false"></ul>`;
                div_cont.appendChild(columns);



                const ul = document.getElementById(`tag_ul_${div_id}`),
                    input = ul.querySelector("input");

                
                createTag()

                // Function to create tags
                function createTag() {
                    ul.querySelectorAll("li").forEach(li => li.remove());
                    // tags.slice().reverse().forEach(tag => {
                    //     let liTag = `<li>${tag} <i class="uit uit-multiply" onclick="remove(this, '${tag}')"></i></li>`;
                    //     ul.insertAdjacentHTML("afterbegin", liTag);
                    // });
                    // console.log(tags);
                    let liTag = `<li>${tags[div_id]["column_name"]} <i class="uit uit-multiply" onclick="remove(this, '${div_id}')"></i></li>`;
                    ul.insertAdjacentHTML("afterbegin", liTag);
                }

                // Enable dragging on table headers
                const headers = document.querySelectorAll("#data_tbl th");
                headers.forEach(header => {
                    header.setAttribute("draggable", true);
                    header.style.cursor = 'grab';
                    header.addEventListener("dragstart", (e) => {
                        header.style.cursor = 'grabbing';

                        e.dataTransfer.setData("text", e.target.innerText.replace(/[▲▼]/g, ''));
                    });
                });

                // Enable dropping on the input field
                input.addEventListener("dragover", (e) => {
                    e.preventDefault();
                });

                input.addEventListener("drop", (e) => {
                    e.preventDefault();
                    let droppedText = e.dataTransfer.getData("text");
                    

                    if (droppedText.length > 0 && !tags[div_id]["column_name"].includes(droppedText)) {
                        // if (tags.length < 10) {
                        //     tags.push(droppedText);
                        //     createTag();
                        // }

                            tags[div_id]["column_name"] = droppedText;
                            createTag();
                        }
                    
                });


                // Attach the keyup event listener to the input field
                input.addEventListener("keyup", (e) => {
                    showSuggestions(e.target.value);
                    // addTag(e);
                });


                // Extract column names from the table with id 'data_tbl'
                function getColumnNames() {
                    const table = document.getElementById("data_tbl");
                    const headers = table.querySelectorAll("th");
                    return Array.from(headers).map(header => header.innerText.replace(/[▲▼]/g, '').trim());
                }

                const columnNames = getColumnNames();

                // Show suggestions based on input
                function showSuggestions(value) {
                    clearSuggestions();
                    if (value.length === 0) return;
                    const suggestions = columnNames.filter(name => name.toLowerCase().includes(value.toLowerCase()));
                    suggestions.forEach(suggestion => {
                        let suggestionItem = document.createElement('li');
                        suggestionItem.textContent = suggestion;
                        suggestionItem.classList.add('suggestion');
                        suggestionItem.addEventListener('click', () => {
                            // if (!tags.includes(suggestion)) {
                            //     tags.push(suggestion);
                            //     createTag();
                            // }
                            if (!tags[div_id]["column_name"].includes(suggestion)) {

                                tags[div_id]["column_name"] = suggestion;
                                createTag();
                            }
                            input.value = "";
                            clearSuggestions();
                        });

                        input.addEventListener("keypress", (e) => {
                            if (e.key === "Enter") {
                                if (suggestions.length === 1) {
                                    if (!tags[div_id]["column_name"].includes(suggestion)) {

                                    tags[div_id]["column_name"] = suggestion;
                                    createTag();
                                }
                                input.value = "";
                                clearSuggestions();
                                }
                            }
                        });
                        ul.appendChild(suggestionItem);
                    });

                    
                }

                // Clear previous suggestions
                function clearSuggestions() {
                    const suggestions = ul.querySelectorAll('.suggestion');
                    suggestions.forEach(suggestion => suggestion.remove());
                }

                
                logic_list = ['equal','not equal','contains', 'not contains', 'starts with', 'ends with', 'null', 'not null']

                var logic1_opt = document.createElement('select');
                logic1_opt.id= 'logic1_opt'+div_id
                logic1_opt.className= 'logic1_opt'


                // var option1 = document.createElement("option");
                // option1.text = "contains";
                // option1.value = "contains";
                // logic1_opt.appendChild(option1);

                for (var i = 0; i < logic_list.length; i++) {
                    var option = document.createElement("option");

                    // console.log(logic_list[i]);
                    
                    option.text = logic_list[i];
                    option.value = logic_list[i];
                    logic1_opt.appendChild(option);
                    if (logic_list[i] == opt_val['logic1_op']){
                        option.selected = true;
                        // and the defaultSelected value to true:
                        option.defaultSelected = true;
                    }

                    

                }

                div_cont.appendChild(logic1_opt);



                var logic1_value = document.createElement('input');
                logic1_value.type = 'text';
                logic1_value.defaultValue = opt_val['logic1_val'];
                logic1_value.id = 'logic1_value'+div_id;
                logic1_value.className = 'logic1_value';
                div_cont.appendChild(logic1_value);
                div_cont.appendChild(document.createElement('br'));

                var apply_btn = document.createElement('button');
                apply_btn.textContent = 'Apply';
                apply_btn.id = 'apply_btn'+div_id;
                apply_btn.className = 'apply_btn';
                div_cont.appendChild(apply_btn);


                document.getElementById('logic1_opt'+div_id).addEventListener('change', (evt) => {
                    op_va = document.getElementById('logic1_opt'+div_id).value;
                    if (op_va == 'null' || op_va == 'not null'){
                        document.getElementById('logic1_value'+div_id).style.display = 'none';

                    }
                    else{
                        document.getElementById('logic1_value'+div_id).style.display = '';

                    }

                });


                document.getElementById('apply_btn'+div_id).addEventListener('click', () =>{
                    var logic1_op = document.getElementById('logic1_opt'+div_id).value;
                    var logic1_val = document.getElementById('logic1_value'+div_id).value;
                    var column_name = tags[div_id]["column_name"];

                    // console.log(logic1_val);
                    if (!logic1_val){
                        logic1_val = logic1_op;
                    }

                    if (column_name){
                        tags[div_id] = {"logic1_op": logic1_op, "logic1_val": logic1_val,"column_name": column_name,"condition":"condition"}


                        // // console.log(logic1_op, logic1_val, column_name);

                        fetch(`/filter/${logic1_op}/${logic1_val}/${column_name}/${div_id}`) 
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Network response was not ok');
                            }
                            return response.json();
                        })
                        .then(data => {
                           document.getElementById('table_cont').innerHTML = data['html']
                           column_selector_remain()



                        })
                        .catch(error => {
                            // console.error('Error fetching data:', error);
                            // Handle errors here
                        });
                    

                    }else(alert("Column not found"))

                    

                    
                });

            }
            else if (opt_val =='None'){
                opt1 = document.getElementById('logic1_opt');
                opt1.remove();
            }
        }
        else{
            // console.log('heare++++++++++')

            if (opt_val =='condition'){
                tags[div_id] = {"column_name":""}
                var columns = document.createElement('div');
                columns.id = 'filter_columns';
                columns.innerHTML = `<ul id="tag_ul_${div_id}"><input id="col_${div_id}" type="text" spellcheck="false"></ul>`;
                div.appendChild(columns);

                const ul = document.getElementById(`tag_ul_${div_id}`),
                    input = ul.querySelector("input");


                // Function to create tags
                function createTag() {
                    ul.querySelectorAll("li").forEach(li => li.remove());
                    // tags.slice().reverse().forEach(tag => {
                    //     let liTag = `<li>${tag} <i class="uit uit-multiply" onclick="remove(this, '${tag}')"></i></li>`;
                    //     ul.insertAdjacentHTML("afterbegin", liTag);
                    // });

                    let liTag = `<li>${tags[div_id]["column_name"]} <i class="uit uit-multiply" onclick="remove(this, '${div_id}')"></i></li>`;
                    ul.insertAdjacentHTML("afterbegin", liTag);
                }

                // Enable dragging on table headers
                const headers = document.querySelectorAll("#data_tbl th");
                headers.forEach(header => {
                    header.setAttribute("draggable", true);
                    header.style.cursor = 'grab';
                    header.addEventListener("dragstart", (e) => {
                        header.style.cursor = 'grabbing';

                        e.dataTransfer.setData("text", e.target.innerText.replace(/[▲▼]/g, ''));
                    });
                });

                // Enable dropping on the input field
                input.addEventListener("dragover", (e) => {
                    e.preventDefault();
                });

                input.addEventListener("drop", (e) => {
                    e.preventDefault();
                    let droppedText = e.dataTransfer.getData("text");
                    

                    if (droppedText.length > 0 && !tags[div_id]["column_name"].includes(droppedText)) {
                        // if (tags.length < 10) {
                        //     tags.push(droppedText);
                        //     createTag();
                        // }

                            tags[div_id]["column_name"] = droppedText;
                            createTag();
                        }
                    
                });


                // Attach the keyup event listener to the input field
                input.addEventListener("keyup", (e) => {
                    showSuggestions(e.target.value);
                    // addTag(e);
                });


                // Extract column names from the table with id 'data_tbl'
                function getColumnNames() {
                    const table = document.getElementById("data_tbl");
                    const headers = table.querySelectorAll("th");
                    return Array.from(headers).map(header => header.innerText.replace(/[▲▼]/g, '').trim());
                }

                const columnNames = getColumnNames();

                // Show suggestions based on input
                function showSuggestions(value) {
                    clearSuggestions();
                    if (value.length === 0) return;
                    const suggestions = columnNames.filter(name => name.toLowerCase().includes(value.toLowerCase()));
                    suggestions.forEach(suggestion => {
                        let suggestionItem = document.createElement('li');
                        suggestionItem.textContent = suggestion;
                        suggestionItem.classList.add('suggestion');
                        suggestionItem.addEventListener('click', () => {
                            // if (!tags.includes(suggestion)) {
                            //     tags.push(suggestion);
                            //     createTag();
                            // }
                            if (!tags[div_id]["column_name"].includes(suggestion)) {

                                tags[div_id]["column_name"] = suggestion;
                                createTag();
                            }
                            input.value = "";
                            clearSuggestions();
                        });

                        input.addEventListener("keypress", (e) => {
                            if (e.key === "Enter") {
                                if (suggestions.length === 1) {
                                    if (!tags[div_id]["column_name"].includes(suggestion)) {

                                    tags[div_id]["column_name"] = suggestion;
                                    createTag();
                                }
                                input.value = "";
                                clearSuggestions();
                                }
                            }
                        });
                        ul.appendChild(suggestionItem);
                    });

                    
                }

                // Clear previous suggestions
                function clearSuggestions() {
                    const suggestions = ul.querySelectorAll('.suggestion');
                    suggestions.forEach(suggestion => suggestion.remove());
                }

                
                logic_list = ['equal','not equal','contains', 'not contains', 'starts with', 'ends with', 'null', 'not null']

                var logic1_opt = document.createElement('select');
                logic1_opt.id= 'logic1_opt'+div_id
                logic1_opt.className= 'logic1_opt'

                // var option1 = document.createElement("option");
                // option1.text = "contains";
                // option1.value = "contains";
                // logic1_opt.appendChild(option1);

                for (var i = 0; i < logic_list.length; i++) {
                    var option = document.createElement("option");
                    
                    option.text = logic_list[i];
                    option.value = logic_list[i];
                    logic1_opt.appendChild(option);
                }

                div.appendChild(logic1_opt);

                var logic1_value = document.createElement('input');
                logic1_value.type = 'text';
                logic1_value.id = 'logic1_value'+div_id;
                logic1_value.className = 'logic1_value';
                div.appendChild(logic1_value);
                div.appendChild(document.createElement('br'));

                var apply_btn = document.createElement('button');
                apply_btn.textContent = 'Apply';
                apply_btn.id = 'apply_btn'+div_id;
                apply_btn.className = 'apply_btn';
                div.appendChild(apply_btn);

                document.getElementById('logic1_opt'+div_id).addEventListener('change', (evt) => {
                    op_va = document.getElementById('logic1_opt'+div_id).value;
                    if (op_va == 'null' || op_va == 'not null'){
                        document.getElementById('logic1_value'+div_id).style.display = 'none';

                    }
                    else{
                        document.getElementById('logic1_value'+div_id).style.display = '';

                    }

                });

                document.getElementById('apply_btn'+div_id).addEventListener('click', () =>{
                    var logic1_op = document.getElementById('logic1_opt'+div_id).value;
                    var logic1_val = document.getElementById('logic1_value'+div_id).value;
                    var column_name = tags[div_id]["column_name"];

                    // console.log(logic1_val);
                    if (!logic1_val){
                        logic1_val = logic1_op;
                    }

                    if (column_name){
                        tags[div_id] = {"logic1_op": logic1_op, "logic1_val": logic1_val,"column_name": column_name,"condition":"condition"}


                        // // console.log(logic1_op, logic1_val, column_name);

                        fetch(`/filter/${logic1_op}/${logic1_val}/${column_name}/${div_id}`) 
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Network response was not ok');
                            }
                            return response.json();
                        })
                        .then(data => {
                            document.getElementById('table_cont').innerHTML = data['html'] 
                            column_selector_remain()

                        })
                        .catch(error => {
                            // console.error('Error fetching data:', error);
                            // Handle errors here
                        });


                    }else(alert("Column not found"))

                    

                    
                });

            }
            else if (opt_val =='None'){
                opt1 = document.getElementById('logic1_opt');
                opt1.remove();
            }
        }
        
    }

    function filterDiv(div,data='',ex_filter=false) {
        var opt = document.getElementById('filter_option');
        // // filtering(div,opt.value)
        // console.log(ex_filter);
        if(ex_filter ) {
            // console.log('true 0')
            filtering(id,data,true)

        }
        else {
            // console.log('not true 0')
            filtering(div,opt.value,false)

        }

        // opt.addEventListener('change', (event) => {
        //     var opt_val = event.currentTarget.value;
        //     filtering(div,opt_val)
            
        // });
    }

    const resizer = document.querySelector('.resizer');
    const topPanel = document.querySelector('.panels');
    const bottomPanel = document.querySelector('#value_cont');
    const bottomPanel_val = document.querySelector('#value_cont_cont');

    let isResizing = false;

    resizer.addEventListener('mousedown', (e) => {
        isResizing = true;
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
    });

    function onMouseMove(e) {
        if (!isResizing) return;

        const totalHeight = topPanel.offsetHeight + bottomPanel.offsetHeight + resizer.offsetHeight;
        const newTopHeight = e.clientY - topPanel.offsetTop;
        const newBottomHeight = totalHeight - newTopHeight - resizer.offsetHeight;

        topPanel.style.height = `${newTopHeight}px`;
        bottomPanel.style.height = `${newBottomHeight}px`;
        bottomPanel_val.style.height = `${newBottomHeight}px`;
    }

    function onMouseUp() {
        isResizing = false;
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup', onMouseUp);
    }


    // Work sheet

    
    function syncScroll() {
        const textarea = document.getElementById('query_inp');
        const lineNumbers = document.getElementById('sheet_left');
        lineNumbers.scrollTop = textarea.scrollTop;
    }

    

    document.getElementById('three-tab').addEventListener('click', function() {
        
    });

  
    function run_query(){
        // const query = document.getElementById('query_inp').value;
        const query = editor.getValue();

        wrksheet_con_select = document.getElementById('connections_select').value;
        wrksheet_tbl_select = document.getElementById('table_select').value;

        cur_conn = wrksheet_con_select
        cur_tbl = wrksheet_tbl_select

        
        if (wrksheet_tbl_select != '')
        {
            if (query != ''){
                document.getElementById('value_cont_cont').innerHTML = `Loading ...` 
        
                // console.log(joins);

                fetch(`/run_query`,{
                
                    headers : {
                    'Content-Type' : 'application/json'
                    },
                    method : 'POST',
                    body : JSON.stringify({"query" : query,"connection":wrksheet_con_select,"table":wrksheet_tbl_select,"joins":joins})
                    }) 
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                                    
                    document.getElementById('value_cont_cont').innerHTML = `<a href="/xl_download"><i class="fa fa-download"></i></a><div id="table_cont">${data['html']}</div>` 
                    document.getElementById('value_cont_cont').style.overflow = 'hidden'
                })
                .catch(error => {
                    // console.error('Error fetching data:', error);
                    // Handle errors here
                });
            }else{
                document.getElementById('value_cont_cont').innerHTML = `NO result` 

            }
            
        }else{
            alert('No tables selected')
        }
        
        
    }
    

    // worksheet options
    document.getElementById('connections_select').addEventListener('change', ()=>{
        wrksheet_con_select = document.getElementById('connections_select');
        wrksheet_tbl_select = document.getElementById('table_select');

        document.getElementById('table_select').innerHTML = ''

        source = settings['settings'][wrksheet_con_select.value]['source'];

        qry_tbls = settings['sources_list'][wrksheet_con_select.value]
        // // console.log(qry_tbls)    
        qry_tbls = qry_tbls.map(filename => filename.name.replace(`.${source}`, ""));
        



        settings['sources_list'][wrksheet_con_select.value].forEach((tbls)=>{
            // // console.log(tbls.name)
            
            tbls["name"] = tbls.name.replace(`.${source}`,'');
            option = document.createElement("option");

            option.text = tbls["name"];
            option.value = tbls["name"];
            wrksheet_tbl_select.appendChild(option)
        });
        
    });

    function addConnection(){
        document.getElementById('addCon_div').style.display = "flex";
        document.getElementById('body_cont').style.display = 'none';

        con_select = document.getElementById("con_source_select");

        console.log(int_conf['source'])

        int_conf['source'].forEach((src)=>{
            option = document.createElement("option");
            option.text = src;
            option.value = src;
            con_select.appendChild(option)
        });

        add_source_inp()

        con_select.addEventListener('change', ()=>{

            document.getElementById("con_inputs_table_2").innerHTML = "";
            add_source_inp()
        })

    }

    function add_source_inp(){
        source = document.getElementById("con_source_select").value;
        table = document.getElementById("con_inputs_table_2");
        if (source == "csv"){
            tr = document.createElement("tr")
            th = document.createElement("th")
            th.innerText = "select csv files"
            tr.appendChild(th)
            
            td = document.createElement("td")
            td.innerHTML = `<input type='file' id='file' multiple onChange='checkFile("${source}")'></p>`
            tr.appendChild(td)

            table.appendChild(tr)
            
        }else if (source == "parquet"){
            tr = document.createElement("tr")
            th = document.createElement("th")
            th.innerText = "select parquet files"
            tr.appendChild(th)
            
            td = document.createElement("td")
            td.innerHTML = `<input type='file' id='file' multiple onChange='checkFile("${source}")'></p>`
            tr.appendChild(td)

            table.appendChild(tr)
        }
    }

    function checkFile(source){
        var fileInput = document.getElementById('file');
        var selectedFile = fileInput.files;

        for (var i = 0; i < selectedFile.length; i++) {
            fileName = selectedFile[i].name
            format = fileName.slice(fileName.lastIndexOf('.') + 1).toLowerCase()
            console.log(format)
            if (format == source){
                document.getElementById('con_err_p').innerText = ``
                document.getElementById('conn_save_btn').disabled = false
                document.getElementById('conn_save_btn').style.cursor = 'pointer'
            }
            else{
                document.getElementById('conn_save_btn').disabled = true
                document.getElementById('conn_save_btn').style.cursor = 'not-allowed'
                document.getElementById('con_err_p').innerText = `selected file is not ${source} format`
            }
        }
        
    } 
    

    async function save_con(){

        con_name = document.getElementById("con_name_input").value;
        source = document.getElementById("con_source_select").value;

        document.getElementById('con_err_p').innerText = ``
        document.getElementById('con_ok_p').innerText = ``

        var data = new FormData()

        if (con_name == ""){
            alert("Connection name is required")   
        }
        else if(['csv', 'parquet', 'json', 'yaml', 'xlsx'].includes(source)){
            var fileInput = document.getElementById('file');
            var selectedFile = fileInput.files;

            if (selectedFile.length != 0){
                for (var i = 0; i < selectedFile.length; i++) {
                    data.append("file", selectedFile[i])
                }
                run_con_save(con_name,source,data)
            }
            else{
                alert("choose files")
            }
        }
    }

    function run_con_save(con_name,source,data){
        var connection = JSON.stringify({"name": con_name, "source": source});

        data.append("connection", connection);

        const res =   fetch(`/upload_file`,{
            method: "POST",
            body: data
        });
        res.then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }else{
                document.getElementById('con_ok_p').innerText = `Connection saved successfully`
            }
        });
    }

    function close_addCon_div(){
        document.getElementById('addCon_div').style.display = 'none';
        document.getElementById('body_cont').style.display = 'flex';

        document.getElementById('con_err_p').innerText = ``
        document.getElementById('con_ok_p').innerText = ``
        document.getElementById("con_inputs_table_2").innerHTML = "";

        document.getElementById('conn_save_btn').disabled = false
        document.getElementById('conn_save_btn').style.cursor = 'pointer'

        location.reload();

    }


    

</script>
</html>